# Configuração de Profiles Automáticos

## Objetivo

Criar automaticamente um registro na tabela `profiles` sempre que um novo usuário se cadastrar no Supabase.

## Como Funciona

### 1. Trigger no Supabase

O arquivo `profiles-auto-create-trigger.sql` contém:

- **Função `handle_new_user()`**: Executada automaticamente quando um usuário é criado
- **Trigger `on_auth_user_created`**: Escuta inserções na tabela `auth.users`
- **Índice único**: Garante que cada usuário tenha apenas um profile

### 2. Fluxo de Cadastro

```
Usuário se cadastra
       ↓
auth.users (registro criado)
       ↓
Trigger dispara
       ↓
handle_new_user() executa
       ↓
public.profiles (registro criado automaticamente)
```

### 3. Dados Criados

Quando o trigger executa, cria um profile com:

- **user_id**: ID do usuário (FK para `auth.users.id`)
- **name**: Nome extraído de `raw_user_meta_data` ou email como fallback
- **role**: `'user'` (padrão para novos usuários)

## Instalação

### Passo 1: Executar SQL

Execute o arquivo no **SQL Editor** do Supabase:

```sql
-- Cole o conteúdo de profiles-auto-create-trigger.sql
```

### Passo 2: Popular Usuários Existentes (Opcional)

Se você já tem usuários cadastrados sem profile, descomente e execute o bloco no final do SQL:

```sql
INSERT INTO public.profiles (user_id, name, role)
SELECT
  u.id,
  COALESCE(u.raw_user_meta_data->>'name', u.email),
  'user'
FROM auth.users u
LEFT JOIN public.profiles p ON p.user_id = u.id
WHERE p.id IS NULL;
```

### Passo 3: Testar

1. Cadastre um novo usuário na aplicação
2. Verifique a tabela `profiles` no Supabase
3. Deve existir um registro com:
   - `user_id` = ID do novo usuário
   - `name` = Nome ou email
   - `role` = 'user'

## Captura de Nome do Usuário

O trigger tenta pegar o nome nesta ordem:

1. **Metadados do usuário** (`raw_user_meta_data->>'name'`)
2. **Email do usuário** (fallback)

### Para Passar Nome no Cadastro

Se você usa o formulário de cadastro padrão do Supabase, passe os metadados:

```typescript
const { data, error } = await supabase.auth.signUp({
  email: 'usuario@example.com',
  password: 'senha123',
  options: {
    data: {
      name: 'Nome Completo do Usuário' // Será salvo em raw_user_meta_data
    }
  }
})
```

## Estrutura da Tabela Profiles

```sql
create table public.profiles (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_id uuid null,
  name text null,
  role text null default 'user'::text,
  constraint profiles_pkey primary key (id),
  constraint profiles_user_id_fkey foreign key (user_id)
    references auth.users (id) on delete cascade
);
```

## Políticas RLS (Recomendado)

Adicione políticas de segurança para a tabela `profiles`:

```sql
-- Ativar RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Todos podem ver profiles
CREATE POLICY "Anyone can view profiles"
  ON public.profiles
  FOR SELECT
  USING (true);

-- Usuários podem atualizar apenas seu próprio profile
CREATE POLICY "Users can update their own profile"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Apenas o trigger pode inserir (função com SECURITY DEFINER)
-- Não precisa de policy de INSERT para usuários
```

## Verificação

Para verificar se o trigger está ativo:

```sql
-- Ver triggers da tabela auth.users
SELECT * FROM information_schema.triggers
WHERE event_object_table = 'users'
AND trigger_schema = 'auth';

-- Ver função
SELECT * FROM pg_proc
WHERE proname = 'handle_new_user';
```

## Troubleshooting

### Erro: "trigger does not exist"

- Execute o SQL completo novamente no Supabase

### Profile não foi criado para novo usuário

1. Verifique se o trigger está ativo (query acima)
2. Verifique logs de erro no Supabase Dashboard → Database → Logs
3. Teste manualmente a função:

```sql
-- Simular criação de profile
SELECT public.handle_new_user();
```

### Usuários duplicados

O índice único `idx_profiles_user_id` previne duplicatas. Se tentar criar dois profiles para o mesmo `user_id`, vai gerar erro.

## Manutenção

### Atualizar Função

Para modificar a lógica do trigger:

1. Altere a função `handle_new_user()`
2. Execute `CREATE OR REPLACE FUNCTION...`
3. O trigger continua usando a nova versão automaticamente

### Desativar Trigger

```sql
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
```

### Reativar Trigger

```sql
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```
